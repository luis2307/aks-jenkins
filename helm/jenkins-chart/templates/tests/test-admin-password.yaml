apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "jenkins.fullname" . }}-test-admin-password"
  labels:
    {{- include "jenkins.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  serviceAccountName: "{{ include "jenkins.fullname" . }}-test"
  restartPolicy: Never
  containers:
    - name: kubectl
      image: "bitnami/kubectl:1.30"
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh","-c"]
      args:
        - |
          set -euo pipefail
          echo "Waiting for Jenkins pod to be Ready..."
          kubectl -n {{ .Release.Namespace }} wait --for=condition=Ready \
            pod -l app=jenkins-server --timeout=300s

          POD=$(kubectl -n {{ .Release.Namespace }} get pod -l app=jenkins-server \
            -o jsonpath='{.items[0].metadata.name}')

          echo "Reading initialAdminPassword from $POD ..."
          kubectl -n {{ .Release.Namespace }} exec "$POD" -- \
            cat /var/jenkins_home/secrets/initialAdminPassword | tee /tmp/initialAdminPassword

          echo "----- INITIAL ADMIN PASSWORD (copy this) -----"
          cat /tmp/initialAdminPassword
          echo "----------------------------------------------"